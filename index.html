import React, { useState, useMemo, useEffect } from 'react';
import { Search, SlidersHorizontal, FileDown, User, Phone, Wallet, Clock, Calendar, Lock, AlertTriangle, ChevronLeft, ChevronRight, ChevronsLeft, ChevronsRight, Info } from 'lucide-react';

// --- Mock Data (æ¨¡æ“¬æ•¸æ“š) ---
// Based on PRD V1.7 Data Models
const mockMembers = [
  {
    id: 'player_vip01',
    username: 'player_vip01',
    phone: '0912****56',
    status: 'enabled',
    is_under_risk_control: true,
    main_wallet_balance: 1250800.50,
    last_login_time: '2025-08-10T14:12:05Z',
    registration_time: '2025-08-01T10:30:15Z',
    has_deposited: true,
  },
  {
    id: 'suspicious_01',
    username: 'suspicious_01',
    phone: '0988****12',
    status: 'enabled',
    is_under_risk_control: true,
    main_wallet_balance: 88.00,
    last_login_time: '2025-08-09T23:50:01Z',
    registration_time: '2025-08-03T11:20:45Z',
    has_deposited: true,
  },
  {
    id: 'finance_issue_99',
    username: 'finance_issue_99',
    phone: '0933****77',
    status: 'disabled',
    is_under_risk_control: true,
    main_wallet_balance: 150.00,
    last_login_time: '2025-07-22T18:00:00Z',
    registration_time: '2025-07-22T17:30:15Z',
    has_deposited: true,
  },
  {
    id: 'kyc_pending_user',
    username: 'kyc_pending_user',
    phone: '0966****34',
    status: 'enabled',
    is_under_risk_control: false,
    main_wallet_balance: 5320.00,
    last_login_time: '2025-08-10T09:15:22Z',
    registration_time: '2025-07-25T08:00:59Z',
    has_deposited: true,
  },
  {
    id: 'new_user_05',
    username: 'new_user_05',
    phone: '0911****88',
    status: 'enabled',
    is_under_risk_control: false,
    main_wallet_balance: 0.00,
    last_login_time: '2025-08-10T16:45:00Z',
    registration_time: '2025-08-10T16:45:00Z',
    has_deposited: false,
  },
];

const mockMemberProfile = {
  id: 'player_vip01',
  status: 'enabled',
  is_under_risk_control: true,
  overview: {
    financial_summary: { total_deposit: 1500000, total_withdrawal: 250000, total_bet: 8880500, total_win_loss: -250000 },
    key_info: { creation_time: '2025-08-01T10:30:15Z', first_deposit_time: '2025-08-01T11:05:20Z', last_login_time: '2025-08-10T14:12:05Z', last_login_ip: '101.12.50.180', is_last_login_ip_flagged: true, registration_ip: '118.163.25.10', is_registration_ip_flagged: false, registration_device_id: 'A857-D9F8-G6H5-J4K3' },
    tags: ['VIP', 'è€è™æ©Ÿæ„›å¥½è€…', 'é«˜é¡ç©å®¶'],
  },
  account_info: { username: 'player_vip01', phone: '0912345678', real_name: 'é™³*æ–‡', email: 'player***@gmail.com', birth_date: '1990-05-20', gender: 'ç”·' },
  kyc_info: { 
    status: 'approved',
    verified_data: {
        real_name: 'é™³å¤§æ–‡',
        id_number: 'A12****5678',
        birth_date: '1990-05-20',
        address: 'å°åŒ—å¸‚ä¿¡ç¾©å€***è·¯**è™Ÿ',
    },
    records: [{ id: 'kyc001', submission_time: '2025-08-02T10:00:00Z', image_url: 'https://placehold.co/300x200/E2E8F0/4A5568?text=è­‰ä»¶æ­£é¢', reviewer: 'admin01', result: 'å·²é€šé', reason: '' }] 
  },
  finances: {
    wallets: [
      { type: 'main', name: 'ä¸»å¸³æˆ¶', balance: 1250800.50, unsettled_bet: 15000.00, total_balance: 1265800.50, withdrawable_balance: 1200000.00, withdrawal_limit: 5000000.00 },
      { type: 'game_bonus', name: 'é«”è‚²éŒ¢åŒ…', balance: 88000.00, withdrawable_balance: 0, promotion_name: 'é«”è‚²é¦–å­˜é€100%', promotion_bonus: 500.00, wagering_requirement: 20000.00, wagering_progress_percent: 75.5 },
      { type: 'game_bonus', name: 'çœŸäººéŒ¢åŒ…', balance: 12500.00, withdrawable_balance: 0, promotion_name: 'çœŸäººé—–é—œæ´»å‹•', promotion_bonus: 888.00, wagering_requirement: 15000.00, wagering_progress_percent: 45.0 },
      { type: 'game_bonus', name: 'æ£‹ç‰ŒéŒ¢åŒ…', balance: 5300.00, withdrawable_balance: 5300.00, promotion_name: 'æ£‹ç‰ŒVIPè¿”åˆ©', promotion_bonus: 300.00, wagering_requirement: 5300.00, wagering_progress_percent: 100 },
      { type: 'game_bonus', name: 'è€è™æ©ŸéŒ¢åŒ…', balance: 150000.00, withdrawable_balance: 0, promotion_name: 'è€è™æ©Ÿæ•‘æ´é‡‘', promotion_bonus: 2000.00, wagering_requirement: 40000.00, wagering_progress_percent: 10.0 },
    ],
    transaction_history: [
      { id: 'D001', time: '2025-08-10T13:00:00Z', type: 'å­˜æ¬¾', amount: 50000, before_balance: 1200800.50, after_balance: 1250800.50, status: 'æˆåŠŸ', note: 'éŠ€è¡Œå¡è½‰å¸³' },
      { id: 'W001', time: '2025-08-09T18:30:00Z', type: 'ææ¬¾', amount: -20000, before_balance: 1220800.50, after_balance: 1200800.50, status: 'æˆåŠŸ', note: '' },
      { id: 'B001', time: '2025-08-08T10:00:00Z', type: 'ç´…åˆ©æ´¾ç™¼', amount: 500, before_balance: 1220300.50, after_balance: 1220800.50, status: 'æˆåŠŸ', note: 'VIPå‡ç´šç¦®é‡‘' },
      { id: 'ADJ01', time: '2025-08-07T15:00:00Z', type: 'äººå·¥å­˜å…¥', amount: 1000, before_balance: 1219300.50, after_balance: 1220300.50, status: 'æˆåŠŸ', note: 'å®¢æœè£œå–®(æ‰å–®è™•ç†)' },
    ],
  },
  logs: {
    logins: [{ time: '2025-08-10T14:12:05Z', ip: '101.12.50.180', location: 'å°ç£', device: 'Chrome on Windows', result: 'æˆåŠŸ', reason: '' }],
    account_changes: [{ time: '2025-08-05T10:00:00Z', operator: 'player_vip01', item: 'ä¿®æ”¹å¯†ç¢¼', before: '********', after: '********' }, { time: '2025-08-02T11:00:00Z', operator: 'admin01', item: 'èª¿æ•´ç‹€æ…‹', before: 'å•Ÿç”¨', after: 'åœç”¨(é¢¨æ§æ¸¬è©¦)' }],
  },
  staff_notes: [{ time: '2025-08-09T11:00:00Z', operator: 'å®¢æœ A', note: 'æœƒå“¡ä¾†é›»è©¢å•VIPæ´»å‹•è©³æƒ…ï¼Œå·²å‘ŠçŸ¥ã€‚' }],
  active_risk_rules: [{ action: 'ç¦æ­¢å‡ºæ¬¾', reason: 'æµæ°´ä¸è¶³ï¼Œå°šæœ‰ 5000 æµæ°´æœªé”æˆã€‚', expires_at: '2025-08-15T23:59:59Z' }],
};

// --- Helper Components (è¼”åŠ©çµ„ä»¶) ---
const Card = ({ children, className = '' }) => <div className={`bg-white rounded-xl shadow-sm p-6 ${className}`}>{children}</div>;
const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
  const baseClasses = 'px-4 py-2 rounded-lg font-semibold focus:outline-none focus:ring-2 focus:ring-offset-2 transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed';
  const variants = {
    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
    secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300 focus:ring-gray-400',
    danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
  };
  return <button onClick={onClick} disabled={disabled} className={`${baseClasses} ${variants[variant]} ${className}`}>{children}</button>;
};
const StatusBadge = ({ status }) => {
  const variants = {
    enabled: 'bg-green-100 text-green-800',
    disabled: 'bg-gray-100 text-gray-800',
    approved: 'bg-green-100 text-green-800',
    pending: 'bg-yellow-100 text-yellow-800',
    rejected: 'bg-red-100 text-red-800',
  };
  const text = {
    enabled: 'å•Ÿç”¨',
    disabled: 'åœç”¨',
    approved: 'å·²é€šé',
    pending: 'å¯©æ ¸ä¸­',
    rejected: 'å·²æ‹’çµ•',
  }
  return <span className={`px-2 py-1 text-xs font-medium rounded-full ${variants[status]}`}>{text[status]}</span>;
};
const Tooltip = ({ content, children }) => (
    <div className="relative flex items-center group">
        {children}
        <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs bg-gray-800 text-white text-sm rounded-md p-2 shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-10 pointer-events-none">
            {content}
        </div>
    </div>
);
const formatDate = (dateString) => new Date(dateString).toLocaleString('zh-TW', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\//g, '-');
const formatCurrency = (amount) => `â‚± ${new Intl.NumberFormat('en-US').format(amount.toFixed(2))}`;

// --- Main App Component ---
export default function App() {
  const [currentPage, setCurrentPage] = useState('list');
  const [selectedMember, setSelectedMember] = useState(null);
  const [showModal, setShowModal] = useState(null);

  const handleSelectMember = (member) => {
    setSelectedMember(member);
    setCurrentPage('dashboard');
  };

  const handleBackToList = () => {
    setCurrentPage('list');
    setSelectedMember(null);
  };

  const handleActionClick = (action) => {
    setShowModal(action);
  };

  const Modal = ({ type, onClose }) => {
      const [newStatus, setNewStatus] = useState(selectedMember.status);
      const [isConfirming, setIsConfirming] = useState(false);

      const handleConfirm = () => {
          if (type === 'status' && newStatus === 'disabled' && !isConfirming) {
              setIsConfirming(true);
          } else {
              onClose();
          }
      };

      const renderStatusModal = () => (
        <>
          {!isConfirming ? (
            <>
              <h2 className="text-2xl font-bold text-gray-800 mb-4">èª¿æ•´å¸³è™Ÿç‹€æ…‹</h2>
              <div className="mb-6">
                <label htmlFor="status-select" className="block text-sm font-medium text-gray-700 mb-2">ç‚º {selectedMember.username} é¸æ“‡æ–°ç‹€æ…‹</label>
                <select id="status-select" value={newStatus} onChange={(e) => setNewStatus(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                  <option value="enabled">å•Ÿç”¨</option>
                  <option value="disabled">åœç”¨</option>
                </select>
              </div>
              <p className="text-gray-600 mb-8">è«‹ç¢ºèªæ‚¨çš„æ“ä½œã€‚</p>
            </>
          ) : (
            <>
              <h2 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2"><AlertTriangle/> äºŒæ¬¡ç¢ºèª</h2>
              <p className="text-gray-600 mb-8">æ‚¨ç¢ºå®šè¦ **åœç”¨** æœƒå“¡ {selectedMember.username} çš„å¸³è™Ÿå—ï¼Ÿ<br/>æ­¤æ“ä½œå°‡å°è‡´æœƒå“¡ç„¡æ³•ç™»å…¥ã€‚</p>
            </>
          )}
          <div className="flex justify-end gap-4">
            <Button variant="secondary" onClick={onClose}>å–æ¶ˆ</Button>
            <Button variant={isConfirming ? 'danger' : 'primary'} onClick={handleConfirm}>
              {isConfirming ? 'ç¢ºèªåœç”¨' : 'ç¢ºèª'}
            </Button>
          </div>
        </>
      );

      const renderLogoutModal = () => (
        <>
          <h2 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2"><AlertTriangle/> ç¢ºèªå¼·åˆ¶ä¸‹ç·š</h2>
          <p className="text-gray-600 mb-8">æ‚¨ç¢ºå®šè¦å¼·åˆ¶ä¸‹ç·š {selectedMember.username} å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
          <div className="flex justify-end gap-4">
            <Button variant="secondary" onClick={onClose}>å–æ¶ˆ</Button>
            <Button variant='danger' onClick={onClose}>ç¢ºèªä¸‹ç·š</Button>
          </div>
        </>
      );

      return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
            {type === 'status' ? renderStatusModal() : renderLogoutModal()}
          </div>
        </div>
      );
  };

  return (
    <div className="bg-gray-50 min-h-screen font-sans text-gray-800">
      <div className="p-4 sm:p-8">
        {currentPage === 'list' && <MemberListPage onSelectMember={handleSelectMember} />}
        {currentPage === 'dashboard' && selectedMember && <MemberDashboardPage member={selectedMember} onBack={handleBackToList} onActionClick={handleActionClick} />}
      </div>
      {showModal && <Modal type={showModal} onClose={() => setShowModal(null)} />}
    </div>
  );
}

// --- Page Components ---
function MemberListPage({ onSelectMember }) {
  const [tempFilters, setTempFilters] = useState({ searchTerm: '', status: 'all', has_deposited: 'all' });
  const [appliedFilters, setAppliedFilters] = useState(tempFilters);
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 5;

  const handleSearch = () => {
      setAppliedFilters(tempFilters);
      setCurrentPage(1);
  };

  const handleReset = () => {
      const initialFilters = { searchTerm: '', status: 'all', has_deposited: 'all' };
      setTempFilters(initialFilters);
      setAppliedFilters(initialFilters);
      setCurrentPage(1);
  };

  const filteredMembers = useMemo(() => {
    return mockMembers.filter(m => {
      const searchTermMatch = m.username.toLowerCase().includes(appliedFilters.searchTerm.toLowerCase()) || m.phone.includes(appliedFilters.searchTerm);
      const statusMatch = appliedFilters.status === 'all' || m.status === appliedFilters.status;
      const depositMatch = appliedFilters.has_deposited === 'all' || String(m.has_deposited) === appliedFilters.has_deposited;
      return searchTermMatch && statusMatch && depositMatch;
    });
  }, [appliedFilters]);
  
  const paginatedMembers = useMemo(() => {
      const startIndex = (currentPage - 1) * itemsPerPage;
      return filteredMembers.slice(startIndex, startIndex + itemsPerPage);
  }, [filteredMembers, currentPage]);

  const totalPages = Math.ceil(filteredMembers.length / itemsPerPage);

  const handlePageChange = (newPage) => {
      if (newPage >= 1 && newPage <= totalPages) {
          setCurrentPage(newPage);
      }
  }

  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold text-gray-900">ğŸ‘¥ æœƒå“¡æŸ¥è©¢</h1>
      <Card>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <div className="lg:col-span-2">
            <label className="text-sm font-medium text-gray-700">æœå°‹</label>
            <div className="relative mt-1">
              <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
              <input 
                type="text" 
                placeholder="è«‹è¼¸å…¥æœƒå“¡å¸³è™Ÿæˆ–æ‰‹æ©Ÿè™Ÿç¢¼" 
                className="w-full pl-10 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                value={tempFilters.searchTerm}
                onChange={(e) => setTempFilters({...tempFilters, searchTerm: e.target.value})}
              />
            </div>
          </div>
          <div>
            <label className="text-sm font-medium text-gray-700">å¸³è™Ÿç‹€æ…‹</label>
            <select className="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value={tempFilters.status} onChange={(e) => setTempFilters({...tempFilters, status: e.target.value})}>
              <option value="all">å…¨éƒ¨</option>
              <option value="enabled">å•Ÿç”¨</option>
              <option value="disabled">åœç”¨</option>
            </select>
          </div>
           <div>
            <label className="text-sm font-medium text-gray-700">æ˜¯å¦å­˜æ¬¾</label>
            <select className="w-full mt-1 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" value={tempFilters.has_deposited} onChange={(e) => setTempFilters({...tempFilters, has_deposited: e.target.value})}>
              <option value="all">å…¨éƒ¨</option>
              <option value="true">æ˜¯</option>
              <option value="false">å¦</option>
            </select>
          </div>
        </div>
        <div className="flex justify-end gap-2">
          <Button variant="secondary" onClick={handleReset}>é‡è¨­</Button>
          <Button variant="primary" onClick={handleSearch}>æœå°‹</Button>
        </div>
      </Card>
      
      <Card>
        <div className="flex justify-end items-center mb-4 gap-2">
            <Button variant="secondary"><FileDown size={16}/> åŒ¯å‡º</Button>
            <button className="p-2 rounded-md hover:bg-gray-100"><SlidersHorizontal size={16}/></button>
        </div>
        <div className="overflow-x-auto">
          <table className="w-full text-sm text-left">
            <thead className="bg-gray-50 text-gray-600 uppercase text-xs">
              <tr>
                <th className="p-4">æœƒå“¡å¸³è™Ÿ</th><th className="p-4">æ‰‹æ©Ÿè™Ÿç¢¼</th><th className="p-4">ç‹€æ…‹</th><th className="p-4">é¢¨æ§ç‹€æ…‹</th><th className="p-4 text-right">ä¸»éŒ¢åŒ…é¤˜é¡</th><th className="p-4">æœ€å¾Œç™»å…¥æ™‚é–“</th><th className="p-4">è¨»å†Šæ™‚é–“</th><th className="p-4 text-center">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody className="divide-y">
              {paginatedMembers.map(member => (
                <tr key={member.id} className="hover:bg-gray-50">
                  <td className="p-4 font-medium text-gray-900 flex items-center gap-2"><User size={16} className="text-gray-400"/> {member.username}</td>
                  <td className="p-4"><Phone size={16} className="inline-block mr-2 text-gray-400"/>{member.phone}</td>
                  <td className="p-4"><StatusBadge status={member.status} /></td>
                  <td className="p-4 text-center">{member.is_under_risk_control && <Tooltip content="è©²æœƒå“¡å—é¢¨æ§è¦å‰‡å½±éŸ¿"><Lock size={16} className="text-yellow-600"/></Tooltip>}</td>
                  <td className="p-4 text-right font-mono"><Wallet size={16} className="inline-block mr-2 text-gray-400"/>{formatCurrency(member.main_wallet_balance)}</td>
                  <td className="p-4"><Clock size={16} className="inline-block mr-2 text-gray-400"/>{formatDate(member.last_login_time)}</td>
                  <td className="p-4"><Calendar size={16} className="inline-block mr-2 text-gray-400"/>{formatDate(member.registration_time)}</td>
                  <td className="p-4 text-center"><button onClick={() => onSelectMember(member)} className="text-blue-600 hover:underline font-semibold">æŸ¥çœ‹è©³æƒ…</button></td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
        {paginatedMembers.length === 0 && <div className="text-center py-12 text-gray-500">æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æœƒå“¡ï¼Œè«‹å˜—è©¦æ›´æ›ç¯©é¸æ¢ä»¶ã€‚</div>}
        <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={handlePageChange} />
      </Card>
    </div>
  );
}

function MemberDashboardPage({ member, onBack, onActionClick }) {
  const [activeTab, setActiveTab] = useState('summary');
  const profile = mockMemberProfile;

  const tabs = [
    { id: 'summary', label: 'ç¸½è¦½' }, { id: 'account', label: 'å¸³æˆ¶è³‡è¨Š' }, { id: 'kyc', label: 'KYC è³‡æ–™' }, { id: 'finances', label: 'éŒ¢åŒ…èˆ‡å¸³å‹™' }, { id: 'logs', label: 'æ“ä½œæ—¥èªŒ' }, { id: 'notes', label: 'äººå“¡å‚™è¨»' },
  ];

  const renderTabContent = () => {
    switch (activeTab) {
      case 'summary': return <SummaryTab profile={profile} />;
      case 'account': return <AccountInfoTab profile={profile} />;
      case 'kyc': return <KycTab profile={profile} />;
      case 'finances': return <FinancesTab profile={profile} />;
      case 'logs': return <LogsTab profile={profile} />;
      case 'notes': return <NotesTab profile={profile} />;
      default: return null;
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-start">
        <div>
          <button onClick={onBack} className="flex items-center gap-2 text-gray-600 hover:text-gray-900 mb-2">
            <ChevronLeft size={20} /> è¿”å›æœƒå“¡æŸ¥è©¢
          </button>
          <div className="flex items-center gap-4">
            <h1 className="text-3xl font-bold text-gray-900">{member.username}</h1>
            <StatusBadge status={profile.status} />
            {profile.is_under_risk_control && (
                <Tooltip content={
                    <div className="text-left">
                        <p className="font-bold border-b pb-1 mb-1">ç”Ÿæ•ˆä¸­çš„é¢¨æ§è¦å‰‡</p>
                        {profile.active_risk_rules.map((rule, i) => <p key={i}>â€¢ {rule.action}: {rule.reason}</p>)}
                    </div>
                }>
                    <div className="flex items-center gap-1 bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-sm cursor-pointer">
                        <Lock size={14} /> é¢¨éšªç®¡åˆ¶ä¸­
                    </div>
                </Tooltip>
            )}
          </div>
        </div>
        <div className="flex gap-2">
          <Button variant="secondary" onClick={() => onActionClick('status')}>èª¿æ•´ç‹€æ…‹</Button>
          <Button variant="danger" onClick={() => onActionClick('logout')}>å¼·åˆ¶ä¸‹ç·š</Button>
        </div>
      </div>

      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs">
          {tabs.map(tab => (
            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`shrink-0 ${activeTab === tab.id ? 'border-blue-600 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'} whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm`}>
              {tab.label}
            </button>
          ))}
        </nav>
      </div>
      <div>{renderTabContent()}</div>
    </div>
  );
}

// --- Tab Components ---
const SummaryTab = ({ profile }) => (
  <div className="space-y-8">
    <Card><h3 className="text-lg font-semibold mb-4">æ•¸æ“šç¸½è¦½</h3><div className="grid grid-cols-2 md:grid-cols-4 gap-6 text-center"><div><p className="text-sm text-gray-500">ç¸½å­˜æ¬¾</p><p className="text-2xl font-bold">{formatCurrency(profile.overview.financial_summary.total_deposit)}</p></div><div><p className="text-sm text-gray-500">ç¸½ææ¬¾</p><p className="text-2xl font-bold">{formatCurrency(profile.overview.financial_summary.total_withdrawal)}</p></div><div><p className="text-sm text-gray-500">ç¸½æŠ•æ³¨</p><p className="text-2xl font-bold">{formatCurrency(profile.overview.financial_summary.total_bet)}</p></div><div><p className="text-sm text-gray-500">ç¸½è¼¸è´</p><p className={`text-2xl font-bold ${profile.overview.financial_summary.total_win_loss < 0 ? 'text-red-600' : 'text-green-600'}`}>{formatCurrency(profile.overview.financial_summary.total_win_loss)}</p></div></div></Card>
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8"><Card><h3 className="text-lg font-semibold mb-4">é—œéµæ™‚é–“é»</h3><div className="space-y-3 text-sm"><div className="flex justify-between"><span>å‰µå¸³æ™‚é–“</span><span className="font-mono">{formatDate(profile.overview.key_info.creation_time)}</span></div><div className="flex justify-between"><span>é¦–æ¬¡å……å€¼æ™‚é–“</span><span className="font-mono">{formatDate(profile.overview.key_info.first_deposit_time)}</span></div><div className="flex justify-between"><span>æœ€å¾Œç™»å…¥æ™‚é–“</span><span className="font-mono">{formatDate(profile.overview.key_info.last_login_time)}</span></div></div></Card><Card><h3 className="text-lg font-semibold mb-4">é—œéµä¾†æºè³‡è¨Š</h3><div className="space-y-3 text-sm"><div className="flex justify-between items-center"><span>ä¸Šæ¬¡ç™»å…¥IP</span><span className="font-mono flex items-center gap-2">{profile.overview.key_info.last_login_ip} {profile.overview.key_info.is_last_login_ip_flagged && <Tooltip content="æ­¤IPå·²è¢«é¢¨æ§æ¨™è¨˜"><AlertTriangle size={16} className="text-red-500"/></Tooltip>}</span></div><div className="flex justify-between"><span>è¨»å†ŠIP</span><span className="font-mono">{profile.overview.key_info.registration_ip}</span></div><div className="flex justify-between"><span>è¨»å†Šè£ç½®ç¢¼</span><span className="font-mono">{profile.overview.key_info.registration_device_id}</span></div></div></Card></div>
    <Card><h3 className="text-lg font-semibold mb-4">ç©å®¶æ¨™ç±¤</h3><div className="flex flex-wrap gap-2">{profile.overview.tags.map(tag => <span key={tag} className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">{tag}</span>)}</div></Card>
  </div>
);

const AccountInfoTab = ({ profile }) => (<Card><h3 className="text-lg font-semibold mb-6">åŸºæœ¬è³‡æ–™</h3><div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm"><div className="flex justify-between border-b pb-2"><span className="text-gray-500">æœƒå“¡å¸³è™Ÿ</span><span>{profile.account_info.username}</span></div><div className="flex justify-between border-b pb-2"><span className="text-gray-500">æ‰‹æ©Ÿè™Ÿç¢¼</span><span>{profile.account_info.phone}</span></div><div className="flex justify-between border-b pb-2"><span className="text-gray-500">çœŸå¯¦å§“å</span><span>{profile.account_info.real_name}</span></div><div className="flex justify-between border-b pb-2"><span className="text-gray-500">é›»å­éƒµä»¶</span><span>{profile.account_info.email}</span></div><div className="flex justify-between border-b pb-2"><span className="text-gray-500">ç”Ÿæ—¥</span><span>{profile.account_info.birth_date}</span></div><div className="flex justify-between border-b pb-2"><span className="text-gray-500">æ€§åˆ¥</span><span>{profile.account_info.gender}</span></div></div></Card>);

const KycTab = ({ profile }) => (
    <div className="space-y-8">
        <Card>
            <div className="flex items-center gap-4 mb-6">
                <h3 className="text-lg font-semibold">KYC ç‹€æ…‹</h3>
                <StatusBadge status={profile.kyc_info.status} />
            </div>
            <h4 className="text-md font-semibold mb-4">å·²é©—è­‰è³‡æ–™</h4>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm bg-gray-50 p-4 rounded-lg">
                <div className="flex justify-between"><span className="text-gray-500">èªè­‰å§“å</span><span>{profile.kyc_info.verified_data.real_name}</span></div>
                <div className="flex justify-between"><span className="text-gray-500">è­‰ä»¶è™Ÿç¢¼</span><span>{profile.kyc_info.verified_data.id_number}</span></div>
                <div className="flex justify-between"><span className="text-gray-500">èªè­‰ç”Ÿæ—¥</span><span>{profile.kyc_info.verified_data.birth_date}</span></div>
                <div className="flex justify-between md:col-span-2"><span className="text-gray-500">èªè­‰åœ°å€</span><span>{profile.kyc_info.verified_data.address}</span></div>
            </div>
        </Card>
        <Card>
            <h4 className="text-md font-semibold mb-4">æäº¤ç´€éŒ„</h4>
            <div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-gray-50 text-left"><tr><th className="p-3">æäº¤æ™‚é–“</th><th className="p-3">è­‰ä»¶åœ–ç‰‡</th><th className="p-3">å¯©æ ¸äººå“¡</th><th className="p-3">å¯©æ ¸çµæœ</th></tr></thead><tbody>{profile.kyc_info.records.map(record => (<tr key={record.id} className="border-b"><td className="p-3">{formatDate(record.submission_time)}</td><td className="p-3"><img src={record.image_url} alt="è­‰ä»¶" className="w-24 h-auto rounded-md cursor-pointer hover:opacity-80 transition-opacity" /></td><td className="p-3">{record.reviewer}</td><td className="p-3"><StatusBadge status={record.result === 'å·²é€šé' ? 'approved' : 'rejected'} /></td></tr>))}</tbody></table></div>
        </Card>
    </div>
);

const FinancesTab = ({ profile }) => (
    <div className="space-y-8">
        <Card>
            <h3 className="text-lg font-semibold mb-4">éŒ¢åŒ…ç¸½è¦½</h3>
            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                {profile.finances.wallets.map(wallet => (
                    <div key={wallet.name} className="bg-gray-50 p-4 rounded-lg border flex flex-col justify-between">
                        <div>
                            <h4 className="font-bold mb-2 text-gray-800">{wallet.name}</h4>
                            {wallet.type === 'main' ? (
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between"><span>ç¾é‡‘é¤˜é¡</span><span className="font-mono">{formatCurrency(wallet.balance)}</span></div>
                                    <div className="flex justify-between"><span>ä¸‹æ³¨æœªçµé¡</span><span className="font-mono">{formatCurrency(wallet.unsettled_bet)}</span></div>
                                    <div className="flex justify-between font-semibold border-t pt-2 mt-2"><span>åˆè¨ˆé¤˜é¡</span><span className="font-mono">{formatCurrency(wallet.total_balance)}</span></div>
                                    <div className="flex justify-between text-green-600 font-semibold"><span>å¯æé‡‘é¡</span><span className="font-mono">{formatCurrency(wallet.withdrawable_balance)}</span></div>
                                </div>
                            ) : (
                                 <div className="space-y-2 text-sm">
                                    <p className="font-semibold text-blue-600 truncate" title={wallet.promotion_name}>{wallet.promotion_name}</p>
                                    <div className="flex justify-between"><span>éŒ¢åŒ…é¤˜é¡</span><span className="font-mono">{formatCurrency(wallet.balance)}</span></div>
                                    <div className="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                                        <div className="bg-blue-600 h-2.5 rounded-full" style={{width: `${wallet.wagering_progress_percent}%`}}></div>
                                    </div>
                                    <div className="flex justify-between text-xs text-gray-500">
                                        <span>æµæ°´é”æˆç‡: {wallet.wagering_progress_percent}%</span>
                                        <span>ç›®æ¨™: {formatCurrency(wallet.wagering_requirement)}</span>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                ))}
            </div>
        </Card>
        <Card>
            <h3 className="text-lg font-semibold mb-4">äº¤æ˜“ç´€éŒ„</h3>
             <div className="overflow-x-auto">
              <table className="w-full text-sm">
                <thead className="bg-gray-50 text-left">
                  <tr>
                    <th className="p-3">äº¤æ˜“å–®è™Ÿ</th><th className="p-3">äº¤æ˜“æ™‚é–“</th><th className="p-3">é¡å‹</th><th className="p-3 text-right">é‡‘é¡</th><th className="p-3 text-right">äº¤æ˜“å¾Œé¤˜é¡</th><th className="p-3">ç‹€æ…‹</th><th className="p-3">å‚™è¨»</th>
                  </tr>
                </thead>
                <tbody>
                  {profile.finances.transaction_history.map(tx => (
                    <tr key={tx.id} className="border-b">
                      <td className="p-3 font-mono text-gray-500">{tx.id}</td>
                      <td className="p-3">{formatDate(tx.time)}</td>
                      <td className="p-3 font-medium">{tx.type}</td>
                      <td className={`p-3 text-right font-mono ${tx.amount > 0 ? 'text-green-600' : 'text-red-600'}`}>{tx.amount > 0 ? '+' : ''}{formatCurrency(tx.amount)}</td>
                      <td className="p-3 text-right font-mono text-gray-600">{formatCurrency(tx.after_balance)}</td>
                      <td className="p-3"><StatusBadge status={tx.status === 'æˆåŠŸ' ? 'approved' : 'rejected'} /></td>
                      <td className="p-3 text-gray-500">{tx.note}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
        </Card>
    </div>
);

const LogsTab = ({ profile }) => {
    const [activeLogTab, setActiveLogTab] = useState('login');
    return (
        <Card>
            <div className="flex border-b mb-4"><button onClick={() => setActiveLogTab('login')} className={`py-2 px-4 ${activeLogTab === 'login' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`}>ç™»å…¥ç´€éŒ„</button><button onClick={() => setActiveLogTab('account')} className={`py-2 px-4 ${activeLogTab === 'account' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-500'}`}>å¸³æˆ¶è®Šå‹•ç´€éŒ„</button></div>
            {activeLogTab === 'login' ? (
                <div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-gray-50 text-left"><tr><th className="p-3">æ™‚é–“</th><th className="p-3">IPä½å€</th><th className="p-3">åœ°ç†ä½ç½®</th><th className="p-3">ç™»å…¥è£ç½®</th><th className="p-3">çµæœ</th></tr></thead><tbody>{profile.logs.logins.map((log, i) => <tr key={i} className="border-b"><td className="p-3">{formatDate(log.time)}</td><td className="p-3">{log.ip}</td><td className="p-3">{log.location}</td><td className="p-3">{log.device}</td><td className="p-3"><StatusBadge status={log.result === 'æˆåŠŸ' ? 'approved' : 'rejected'} /></td></tr>)}</tbody></table></div>
            ) : (
                <div className="overflow-x-auto"><table className="w-full text-sm"><thead className="bg-gray-50 text-left"><tr><th className="p-3">æ™‚é–“</th><th className="p-3">æ“ä½œäºº</th><th className="p-3">è®Šæ›´é …ç›®</th><th className="p-3">è®Šæ›´å‰</th><th className="p-3">è®Šæ›´å¾Œ</th></tr></thead><tbody>{profile.logs.account_changes.map((log, i) => <tr key={i} className="border-b"><td className="p-3">{formatDate(log.time)}</td><td className="p-3">{log.operator}</td><td className="p-3">{log.item}</td><td className="p-3">{log.before}</td><td className="p-3">{log.after}</td></tr>)}</tbody></table></div>
            )}
        </Card>
    );
};

const NotesTab = ({ profile }) => (<div className="grid grid-cols-1 lg:grid-cols-3 gap-8"><div className="lg:col-span-2"><Card><h3 className="text-lg font-semibold mb-4">æ­·å²å‚™è¨»</h3><div className="space-y-4">{profile.staff_notes.map((note, i) => (<div key={i} className="bg-gray-50 p-4 rounded-lg"><p className="text-sm text-gray-800 mb-2">{note.note}</p><div className="text-xs text-gray-500 flex justify-end"><span>{note.operator} æ–¼ {formatDate(note.time)}</span></div></div>))}</div></Card></div><div><Card><h3 className="text-lg font-semibold mb-4">æ–°å¢å‚™è¨»</h3><textarea className="w-full p-2 border border-gray-300 rounded-lg h-32 focus:ring-blue-500 focus:border-blue-500" placeholder="è«‹è¼¸å…¥å‚™è¨»å…§å®¹..."></textarea><Button className="w-full mt-4">å„²å­˜</Button></Card></div></div>);

const Pagination = ({ currentPage, totalPages, onPageChange }) => {
    if (totalPages <= 1) return null;
    return (
        <div className="flex justify-center items-center mt-6 text-sm">
            <button onClick={() => onPageChange(1)} disabled={currentPage === 1} className="p-2 rounded-md hover:bg-gray-100 disabled:opacity-50"><ChevronsLeft size={16}/></button>
            <button onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 1} className="p-2 rounded-md hover:bg-gray-100 disabled:opacity-50"><ChevronLeft size={16}/></button>
            <div className="mx-2">ç¬¬ {currentPage} é  / å…± {totalPages} é </div>
            <button onClick={() => onPageChange(currentPage + 1)} disabled={currentPage === totalPages} className="p-2 rounded-md hover:bg-gray-100 disabled:opacity-50"><ChevronRight size={16}/></button>
            <button onClick={() => onPageChange(totalPages)} disabled={currentPage === totalPages} className="p-2 rounded-md hover:bg-gray-100 disabled:opacity-50"><ChevronsRight size={16}/></button>
        </div>
    );
};
